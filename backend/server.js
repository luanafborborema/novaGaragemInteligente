// server.js

import express from 'express';
import mongoose from 'mongoose';
import dotenv from 'dotenv';
import cors from 'cors';
import Veiculo from './models/Veiculo.js'; // Caminho para seu modelo de Veiculo.js
import path from 'path'; // Importa o m√≥dulo path para lidar com caminhos de arquivos
import { fileURLToPath } from 'url'; // Necess√°rio para simular __dirname em m√≥dulos ES6

dotenv.config(); // Carrega vari√°veis de ambiente do .env

// Bloco para configurar __dirname em m√≥dulos ES6 (import.meta.url)
// Isso √© essencial para que 'express.static' encontre a pasta correta, assumindo
// que o 'server.js' est√° em uma subpasta (e.g., 'backend/').
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const mongoUriCrud = process.env.MONGO_URI_CRUD;

async function connectCrudDB() {
  if (mongoose.connections[0].readyState) {
    console.log("‚úÖ Mongoose j√° est√° conectado.");
    return;
  }

  if (!mongoUriCrud) {
    console.error("‚ùå ERRO: MONGO_URI_CRUD n√£o est√° definida! Por favor, defina-a no .env (local) ou nas vari√°veis de ambiente do Render (deploy).");
    // Em ambiente de desenvolvimento, isso pode impedir o servidor de iniciar sem a URI.
    // No Render, a aus√™ncia de vari√°veis far√° o deploy falhar antes, o que √© desej√°vel.
    return;
  }

  try {
    await mongoose.connect(mongoUriCrud, {
      serverSelectionTimeoutMS: 5000,
      connectTimeoutMS: 10000,
    });

    console.log("üöÄ Conectado ao MongoDB Atlas!");

    mongoose.connection.on('disconnected', () =>
      console.warn("‚ö†Ô∏è Mongoose foi desconectado!")
    );

    mongoose.connection.on('error', (err) =>
      console.error("‚ùå Erro de conex√£o Mongoose:", err)
    );

  } catch (err) {
    console.error("‚ùå Falha ao conectar ao MongoDB:", err.message);
  }
}

// Conecta no banco
connectCrudDB();

// Configura Express
const app = express();
// Use process.env.PORT para que o Render (e outros hosts) possa atribuir a porta que ele usa.
// O valor 3001 √© um fallback para desenvolvimento local, se n√£o for definido em .env ou pelo ambiente.
const PORT = process.env.PORT || 3001; 

// Middlewares essenciais
app.use(cors()); // Permite requisi√ß√µes de outras origens (seu frontend no navegador)
app.use(express.json()); // Permite que o Express leia JSON no corpo das requisi√ß√µes

// MUITO IMPORTANTE para servir o frontend!
// Esta linha configura o Express para servir arquivos est√°ticos da pasta 'frontend'.
// `path.join(__dirname, '../frontend')` cria o caminho absoluto para a pasta 'frontend'.
// Assume que a estrutura do seu projeto √©:
// novaGaragemInteligente/
// ‚îú‚îÄ‚îÄ backend/ (onde server.js est√°)
// ‚îî‚îÄ‚îÄ frontend/ (onde os arquivos est√°ticos do frontend est√£o)
app.use(express.static(path.join(__dirname, '../frontend')));

// ===========================================
// Rotas da API de CRUD para Ve√≠culos (MongoDB)
// ===========================================

// ENDPOINT para criar um novo ve√≠culo (POST /api/veiculos)
app.post('/api/veiculos', async (req, res) => {
    try {
        const novoVeiculoData = req.body;
        const veiculoCriado = await Veiculo.create(novoVeiculoData); // Cria o documento no MongoDB
        
        console.log('[Servidor] Ve√≠culo criado com sucesso:', veiculoCriado);
        res.status(201).json(veiculoCriado); // Retorna o ve√≠culo criado com status 201 (Created)

    } catch (error) {
        console.error("[Servidor] Erro ao criar ve√≠culo:", error);
        if (error.code === 11000) { // Erro de duplicidade do MongoDB (ex: placa unique j√° existe)
            return res.status(409).json({ error: 'Erro: Ve√≠culo com esta placa j√° existe.' });
        }
        if (error.name === 'ValidationError') { // Erro de valida√ß√£o do Mongoose (campo obrigat√≥rio, etc.)
             const messages = Object.values(error.errors).map(val => val.message);
             return res.status(400).json({ error: `Erros de valida√ß√£o: ${messages.join(' ')}` });
        }
        res.status(500).json({ error: 'Erro interno do servidor ao criar ve√≠culo.' });
    }
});

// ENDPOINT para ler todos os ve√≠culos (GET /api/veiculos)
app.get('/api/veiculos', async (req, res) => {
    try {
        const todosOsVeiculos = await Veiculo.find(); // Busca todos os documentos na cole√ß√£o 'veiculos'
        
        console.log('[Servidor] Buscando todos os ve√≠culos do DB.');
        res.json(todosOsVeiculos); // Retorna todos os ve√≠culos encontrados

    } catch (error) {
        console.error("[Servidor] Erro ao buscar ve√≠culos:", error);
        res.status(500).json({ error: 'Erro interno do servidor ao buscar ve√≠culos.' });
    }
});

// ENDPOINT para atualizar um ve√≠culo por ID (PUT /api/veiculos/:id)
app.put('/api/veiculos/:id', async (req, res) => {
    try {
        const { id } = req.params; // Pega o ID do ve√≠culo da URL
        const dadosAtualizacao = req.body; // Pega os dados a serem atualizados do corpo da requisi√ß√£o

        // Encontra e atualiza o documento. `{ new: true }` retorna a vers√£o atualizada.
        // `{ runValidators: true }` executa as valida√ß√µes do schema na atualiza√ß√£o.
        const veiculoAtualizado = await Veiculo.findByIdAndUpdate(id, dadosAtualizacao, { new: true, runValidators: true });

        if (!veiculoAtualizado) {
            return res.status(404).json({ error: 'Ve√≠culo n√£o encontrado para atualiza√ß√£o.' });
        }
        
        console.log('[Servidor] Ve√≠culo atualizado com sucesso:', veiculoAtualizado);
        res.json(veiculoAtualizado);

    } catch (error) {
        console.error("[Servidor] Erro ao atualizar ve√≠culo:", error);
        if (error.code === 11000) { 
            return res.status(409).json({ error: 'Erro de duplicidade: Ve√≠culo com esta placa j√° existe.' });
        }
        if (error.name === 'ValidationError') { 
             const messages = Object.values(error.errors).map(val => val.message);
             return res.status(400).json({ error: `Erros de valida√ß√£o: ${messages.join(' ')}` });
        }
        if (error.name === 'CastError' && error.path === '_id') { // Erro se o ID n√£o for v√°lido para o MongoDB
            return res.status(400).json({ error: 'ID de ve√≠culo inv√°lido ou formato incorreto.' });
        }
        res.status(500).json({ error: 'Erro interno do servidor ao atualizar ve√≠culo.' });
    }
});

// ENDPOINT para deletar um ve√≠culo por ID (DELETE /api/veiculos/:id)
app.delete('/api/veiculos/:id', async (req, res) => {
    try {
        const { id } = req.params; // Pega o ID do ve√≠culo da URL

        const veiculoDeletado = await Veiculo.findByIdAndDelete(id); // Encontra e deleta o documento

        if (!veiculoDeletado) {
            return res.status(404).json({ error: 'Ve√≠culo n√£o encontrado para remo√ß√£o.' });
        }
        
        console.log('[Servidor] Ve√≠culo removido com sucesso:', veiculoDeletado);
        res.status(200).json({ message: 'Ve√≠culo removido com sucesso.', veiculo: veiculoDeletado });

    } catch (error) {
        console.error("[Servidor] Erro ao deletar ve√≠culo:", error);
        if (error.name === 'CastError' && error.path === '_id') {
            return res.status(400).json({ error: 'ID de ve√≠culo inv√°lido ou formato incorreto.' });
        }
        res.status(500).json({ error: 'Erro interno do servidor ao deletar ve√≠culo.' });
    }
});


// ======================================
// Rotas da API de Previs√£o do Tempo (Proxy)
// ======================================
const OPENWEATHER_API_KEY = process.env.OPENWEATHER_API_KEY;

app.get('/api/previsao/:cidade', async (req, res) => {
  const { cidade } = req.params;

  if (!OPENWEATHER_API_KEY) {
    return res.status(500).json({ error: 'Chave de API do clima n√£o configurada no servidor (OPENWEATHER_API_KEY). O servidor n√£o pode buscar a previs√£o.' });
  }

  try {
    const urlOpenWeather = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(cidade)}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=pt_br`;
    const responseOpenWeather = await fetch(urlOpenWeather); // Faz a requisi√ß√£o √† API externa

    if (!responseOpenWeather.ok) {
      const errorData = await responseOpenWeather.json().catch(() => ({}));
      // Retorna o status e a mensagem de erro da API externa para o frontend
      return res.status(responseOpenWeather.status).json({ error: errorData.message || 'Erro ao buscar dados do clima na API externa.' });
    }

    const data = await responseOpenWeather.json(); // Pega a resposta da API externa

    const previsaoFormatada = {
      nomeCidade: data.name,
      pais: data.sys.country,
      temperaturaAtual: data.main.temp,
      sensacaoTermica: data.main.feels_like,
      temperaturaMax: data.main.temp_max,
      temperaturaMin: data.main.temp_min,
      descricaoClima: data.weather[0].description,
      iconeClima: data.weather[0].icon,
      velocidadeVento: data.wind.speed
    };

    res.json(previsaoFormatada); // Envia os dados formatados para o frontend

  } catch (error) {
    console.error("[Servidor] Erro ao processar requisi√ß√£o de previs√£o:", error);
    res.status(500).json({ error: 'Erro interno do servidor ao processar a previs√£o.' });
  }
});

// ======================================
// Rotas para Dados da Garagem (Atividade B2.P1.A9)
// ======================================
const veiculosDestaque = [
  { id: 1, modelo: "Tesla Cybertruck", ano: 2024, destaque: "Design Futurista, El√©trico e Potente", imagemUrl: "imagens/tesla.jpeg" },
  { id: 2, modelo: "Ford Maverick H√≠brida", ano: 2023, destaque: "Picape compacta, h√≠brida e vers√°til", imagemUrl: "imagens/maverick.jpeg" },
  { id: 3, modelo: "Porsche Taycan", ano: 2022, destaque: "Esportivo el√©trico de alta performance", imagemUrl: "imagens/porsche.jpeg" },
  { id: 4, modelo: "Honda Civic Type R", ano: 2024, destaque: "Carro esportivo de alto desempenho", imagemUrl: "imagens/civic.jpeg" }
];

const servicosGaragem = [
  { id: "S01", nome: "Troca de √ìleo e Filtro", descricao: "Uso de √≥leo sint√©tico de alta qualidade e troca de filtro de √≥leo.", precoEstimado: "R$ 250,00" },
  { id: "S02", nome: "Balanceamento e Alinhamento", descricao: "Equil√≠brio de rodas e ajuste da geometria da suspens√£o para sua seguran√ßa.", precoEstimado: "R$ 180,00" },
  { id: "S03", nome: "Revis√£o Geral do Sistema de Freios", descricao: "Verifica√ß√£o completa de pastilhas, discos, fluido e ajuste geral do sistema.", precoEstimado: "R$ 350,00" }
];

const ferramentasEssenciais = [
  { id: "F01", nome: "Jogo de Chaves Combinadas", utilidade: "Para parafusos e porcas de diferentes tamanhos, essencial para pequenos reparos.", categoria: "Manual" },
  { id: "F02", nome: "Macaco Hidr√°ulico Automotivo", utilidade: "Para levantar ve√≠culos com seguran√ßa durante a troca de pneus ou manuten√ß√µes.", categoria: "Eleva√ß√£o" },
  { id: "F03", nome: "Chave de Impacto El√©trica", utilidade: "Facilita a remo√ß√£o e aperto r√°pido de porcas de roda e outros fixadores pesados.", categoria: "El√©trica" }
];

// GET para ve√≠culos em destaque
app.get('/api/garagem/veiculos-destaque', (req, res) => {
  res.json(veiculosDestaque);
});

// GET para servi√ßos de oficina
app.get('/api/garagem/servicos-oferecidos', (req, res) => {
  res.json(servicosGaragem);
});

// GET para detalhes de ferramentas (com par√¢metro de ID)
app.get('/api/garagem/ferramentas-essenciais/:idFerramenta', (req, res) => {
  const { idFerramenta } = req.params;
  const ferramenta = ferramentasEssenciais.find(f => f.id === idFerramenta);
  if (ferramenta) {
    res.json(ferramenta);
  } else {
    res.status(404).json({ error: 'Ferramenta n√£o encontrada com o ID fornecido.' });
  }
});

// ======================================
// Rota Raiz (Serve como teste de que o servidor est√° rodando)
// ======================================
// Se a requisi√ß√£o n√£o cair em nenhuma das rotas acima, ela pode tentar carregar o index.html
// por causa do express.static, mas uma rota de '/' espec√≠fica pode ser √∫til para debug no Render.
app.get('/', (req, res) => {
    // Redireciona para o index.html se quiser que a rota raiz do backend carregue o frontend
    res.sendFile(path.join(__dirname, '../frontend/index.html'));
    // Ou, para uma mensagem simples de servidor online:
    // res.send('Servidor da Garagem Inteligente Online e servindo arquivos est√°ticos! Acesse a rota correta.');
});


// ======================================
// Iniciar o Servidor
// ======================================
app.listen(PORT, () => {
  console.log(`[BACKEND] Servidor rodando na porta ${PORT}`);
});